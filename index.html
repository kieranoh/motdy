<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>합주 예약 시스템</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1,h2 { margin-bottom: 10px; }
    #loginSection { margin-bottom: 20px; }
    #user-info { margin-top: 8px; font-weight: bold; }
    #adminControls { margin-top: 20px; }
    /* 스케줄 테이블 */
    .schedule-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      font-size: 1rem;
    }
    .schedule-table th,
    .schedule-table td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
      min-width: 60px;
      height: 30px;
    }
    .schedule-table th { background: #f7f7f7; }
    /* 예약 모달 */
    #bookingOverlay {
      display: none;
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.3); z-index: 900;
    }
    #bookingForm {
      display: none;
      position: fixed; top:50%; left:50%;
      transform: translate(-50%,-50%);
      background: #fff; padding:20px;
      border:1px solid #999; box-shadow:0 2px 10px rgba(0,0,0,0.2);
      z-index:1000; width:300px;
    }
    #bookingForm label { display:block; margin:8px 0; }
    #bookingForm button { margin-right:8px; }
    /* 슬롯 리스트 */
    #slot-list-admin li,
    #slot-list li { margin:4px 0; }
  </style>
</head>
<body>
  <h1>합주 예약 시스템</h1>

  <!-- 로그인 -->
  <div id="loginSection">
    <button id="btn-google-login">구글 로그인</button>
    <button id="btn-logout" style="display:none;">로그아웃</button>
    <div id="user-info"></div>
  </div>

  <!-- 관리자 슬롯 생성 (생략 가능) -->
  <div id="adminControls" style="display:none;">
    <h2>관리자: 슬롯 생성</h2>
    시작일: <input type="date" id="start-date">
    종료일: <input type="date" id="end-date"><br>
    시작시간: <input type="time" id="start-time" value="08:00">
    종료시간: <input type="time" id="end-time" value="20:00"><br>
    <button id="btn-create-slots">일괄 생성</button>
    <ul id="slot-list-admin"></ul>
  </div>

  <!-- 사용자 슬롯 리스트 -->
  <div id="userSlots" style="margin-top:20px;">
    <h2>예약 가능한 슬롯</h2>
    <ul id="slot-list"></ul>
  </div>

  <!-- 이번 주 스케줄 -->
  <h2>이번 주 스케줄 (30분 단위, 월~일 8:00~23:30)</h2>
  <table class="schedule-table" id="weekly-schedule">
    <thead>
      <tr>
        <th>시간</th>
        <th>월</th><th>화</th><th>수</th>
        <th>목</th><th>금</th><th>토</th><th>일</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 예약 모달 오버레이 -->
  <div id="bookingOverlay"></div>

  <!-- 예약 폼 -->
  <div id="bookingForm">
    <h2>예약하기</h2>
    <form id="formBooking">
      <label>
        예약 타입:
        <label><input type="radio" name="type" value="합주" checked> 합주</label>
        <label><input type="radio" name="type" value="개인연습"> 개인연습</label>
      </label>
      <label>날짜: <input type="date" id="form-date" required></label>
      <label>시작 시간: <input type="time" id="form-start" required></label>
      <label>종료 시간: <input type="time" id="form-end" required></label>
      <div id="form-name-team">
        <label id="label-team">팀명: <input type="text" id="form-team"></label>
        <label id="label-name" style="display:none;">이름: <input type="text" id="form-name"></label>
      </div>
      <button type="submit">제출</button>
      <button type="button" id="btn-cancel">취소</button>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // 헬퍼
    function timeToMinutes(s){ const [h,m]=s.split(':').map(Number); return h*60+m; }
    function minutesToTime(m){ return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`; }

    // Firebase 초기화
    const firebaseConfig = {
      apiKey: "AIzaSyCGroYj_1Mpw0GBUn0p37z4Nncl1chqLUc",
      authDomain: "motdy-2b3ea.firebaseapp.com",
      databaseURL: "https://motdy-2b3ea-default-rtdb.firebaseio.com",
      projectId: "motdy-2b3ea",
      storageBucket: "motdy-2b3ea.appspot.com",
      messagingSenderId: "376404804075",
      appId: "1:376404804075:web:d4d85f0baab14fe3a859ae"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const rdb  = firebase.database();

    // UI 바인딩
    const btnGoogle   = document.getElementById('btn-google-login');
    const btnLogout   = document.getElementById('btn-logout');
    const userInfo    = document.getElementById('user-info');
    const bookingForm = document.getElementById('bookingForm');
    const bookingOv   = document.getElementById('bookingOverlay');
    const formBooking = document.getElementById('formBooking');
    const rbType      = document.getElementsByName('type');
    const labelTeam   = document.getElementById('label-team');
    const labelName   = document.getElementById('label-name');
    const inpDate     = document.getElementById('form-date');
    const inpStart    = document.getElementById('form-start');
    const inpEnd      = document.getElementById('form-end');
    const inpTeam     = document.getElementById('form-team');
    const inpName     = document.getElementById('form-name');
    const btnCancel   = document.getElementById('btn-cancel');

    const adminDiv      = document.getElementById('adminControls');
    const slotListAdmin = document.getElementById('slot-list-admin');
    const btnCreate     = document.getElementById('btn-create-slots');
    const userSlotsDiv  = document.getElementById('userSlots');
    const slotList      = document.getElementById('slot-list');

    let currentSlotId = null;

    // 1) 초기 슬롯 시딩 (RTDB)
    async function seedInitialSlots() {
      const snap = await rdb.ref('availability').once('value');
      if (!snap.exists()) {
        const updates = {};
        const today = new Date();
        // 이번 주 월요일부터 7일간, 08:00~20:00 한 타임씩 시딩
        const day = today.getDay(), mon = new Date(today);
        mon.setDate(today.getDate() - (day===0?6:day-1));
        for (let i=0; i<7; i++) {
          const d = new Date(mon);
          d.setDate(mon.getDate()+i);
          const dateStr = d.toISOString().slice(0,10);
          const key = rdb.ref('availability').push().key;
          updates[`availability/${key}`] = { date: dateStr, start:'08:00', end:'20:00' };
        }
        await rdb.ref().update(updates);
      }
    }

    // 2) 로그인/로그아웃
    btnGoogle.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    btnLogout.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async user => {
      const token   = user ? await user.getIdTokenResult() : {};
      const isAdmin = token.claims?.admin === true;

      btnGoogle.style.display = user ? 'none' : '';
      btnLogout.style.display = user ? '' : 'none';
      userInfo.textContent    = user ? `환영합니다, ${user.displayName}` : '';
      adminDiv.style.display  = (user && isAdmin) ? '' : 'none';
      userSlotsDiv.style.display = '';  // 항상 보이게

      if (user && isAdmin) await loadAdminSlots();
      else await loadUserSlots();
      renderWeeklySchedule();
    });

    // 3) 관리자 슬롯 생성
    btnCreate.onclick = async () => {
      const sd = document.getElementById('start-date').value;
      const ed = document.getElementById('end-date').value;
      const st = document.getElementById('start-time').value;
      const et = document.getElementById('end-time').value;
      const start = new Date(sd), end = new Date(ed);
      const updates = {};
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        const dateStr = d.toISOString().slice(0,10);
        const key     = rdb.ref('availability').push().key;
        updates[`availability/${key}`] = { date: dateStr, start: st, end: et };
      }
      await rdb.ref().update(updates);
      await loadAdminSlots();
      renderWeeklySchedule();
    };
    async function loadAdminSlots() {
      slotListAdmin.innerHTML = '';
      const snap = await rdb.ref('availability').orderByChild('date').once('value');
      snap.forEach(ch => {
        const { date,start,end } = ch.val();
        const li = document.createElement('li');
        li.textContent = `${date} ${start}~${end}`;
        slotListAdmin.appendChild(li);
      });
    }

    // 4) 사용자 슬롯 리스트
    async function loadUserSlots() {
      slotList.innerHTML = '';
      const snap = await rdb.ref('availability').orderByChild('date').once('value');
      snap.forEach(ch => {
        const id = ch.key;
        const { date,start,end } = ch.val();
        const li = document.createElement('li');
        li.textContent = `${date} ${start}~${end} : `;
        rdb.ref(`bookings/${id}`).once('value').then(bsnap => {
          if (bsnap.exists()) {
            const b = bsnap.val();
            const who = b.type==='합주'? b.team: b.name;
            li.textContent += `예약완료 (${who})`;
          } else {
            const btn = document.createElement('button');
            btn.textContent = '예약하기';
            btn.onclick = () => {
              currentSlotId = id;
              inpDate.value  = date;
              inpStart.value = start;
              inpEnd.value   = end;
              rbType[0].checked = true;
              labelTeam.style.display = '';
              labelName.style.display = 'none';
              bookingOv.style.display = '';
              bookingForm.style.display = '';
            };
            li.appendChild(btn);
          }
        });
        slotList.appendChild(li);
      });
    }

    // 5) 예약 모달 반응
    btnCancel.onclick = () => {
      bookingForm.style.display = 'none';
      bookingOv  .style.display = 'none';
    };
    rbType.forEach(r=> r.onchange = () => {
      labelTeam.style.display = r.checked && r.value==='합주' ? '' : 'none';
      labelName.style.display = r.checked && r.value==='개인연습' ? '' : 'none';
    });

    formBooking.onsubmit = async e => {
      e.preventDefault();
      const type  = [...rbType].find(r=>r.checked).value;
      const date  = inpDate.value;
      const s     = inpStart.value, eT = inpEnd.value;
      if (!date||!s||!eT) return alert('모든 필드를 채워주세요.');
      if (type==='개인연습' && date!== new Date().toISOString().slice(0,10))
        return alert('개인연습은 당일만 가능');
      const sMin = timeToMinutes(s), eMin = timeToMinutes(eT), dur=eMin-sMin;
      if (dur<30||dur>60) return alert('30~60분만 예약 가능');

      // 충돌 검사
      const bsnap = await rdb.ref('bookings').orderByChild('date').equalTo(date).once('value');
      let conflict = false;
      bsnap.forEach(ch => {
        if (ch.key===currentSlotId) return;
        const b = ch.val(); const bs = timeToMinutes(b.start), be = timeToMinutes(b.end);
        if (sMin < be && eMin > bs) conflict = true;
      });
      if (conflict) return alert('이미 예약이 있습니다.');

      const payload = { date, start:s, end:eT, type };
      if (type==='합주') {
        if (!inpTeam.value) return alert('팀명 입력');
        payload.team = inpTeam.value;
      } else {
        if (!inpName.value) return alert('이름 입력');
        payload.name = inpName.value;
      }

      await rdb.ref(`bookings/${currentSlotId}`).set(payload);
      alert('예약 완료!');
      btnCancel.click();
      await loadUserSlots();
      renderWeeklySchedule();
    };

    // 6) 주간 스케줄 렌더링
    async function renderWeeklySchedule() {
      const tbody = document.querySelector('#weekly-schedule tbody');
      tbody.innerHTML = '';
      const now = new Date(), day=now.getDay();
      const mon = new Date(now);
      mon.setDate(now.getDate() - (day===0?6:day-1));
      mon.setHours(0,0,0,0);

      // 모든 예약 읽기
      const snap = await rdb.ref('bookings').once('value');
      const bookingMap = {};
      snap.forEach(ch => {
        const b = ch.val(), lbl = b.type==='합주'?b.team:b.name;
        const s = timeToMinutes(b.start), e = timeToMinutes(b.end);
        for (let t=s; t<e; t+=30) {
          bookingMap[`${b.date}_${minutesToTime(t)}`] = lbl;
        }
      });

      for (let h=8; h<=23; h++) {
        for (let m=0; m<60; m+=30) {
          const label = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
          const tr = document.createElement('tr');
          tr.innerHTML = `<th>${label}</th>`;
          for (let i=0; i<7; i++) {
            const d = new Date(mon);
            d.setDate(mon.getDate()+i);
            const key = `${d.toISOString().slice(0,10)}_${label}`;
            tr.innerHTML += `<td>${bookingMap[key]||''}</td>`;
          }
          tbody.appendChild(tr);
        }
      }
    }

    // 페이지 로드시
    document.addEventListener('DOMContentLoaded', async () => {
      await seedInitialSlots();
      await loadUserSlots();
      renderWeeklySchedule();
    });
  </script>
</body>
</html>
