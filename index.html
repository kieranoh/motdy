<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>합주 예약 시스템</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1, h2 { margin-bottom: 10px; }
    #loginSection { margin-bottom: 20px; }
    #user-info { margin-top: 8px; font-weight: bold; }
    #btn-reserve { margin-top: 12px; }
    /* 관리자 슬롯 리스트 */
    #slot-list-admin li,
    #slot-list li { margin: 4px 0; }
    /* 스케줄 테이블 */
    .schedule-table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      font-size: 1.1rem;
    }
    .schedule-table th,
    .schedule-table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
      min-width: 80px;
      height: 40px;
    }
    .schedule-table th { background: #f7f7f7; }
    /* 예약 폼 */
    #bookingForm {
      display: none;
      border: 1px solid #ddd;
      padding: 16px;
      margin-top: 20px;
      max-width: 320px;
    }
    #bookingForm label { display: block; margin: 8px 0; }
    #bookingForm button { margin-right: 8px; }
  </style>
</head>
<body>
  <h1>합주 예약 시스템</h1>

  <!-- 로그인 & 사용자 정보 & 예약하기 버튼 -->
  <div id="loginSection">
    <button id="btn-google-login">구글 로그인</button>
    <button id="btn-logout" style="display:none;">로그아웃</button>
    <div id="user-info"></div>
    <button id="btn-reserve" style="display:none;">예약하기</button>
  </div>

  <!-- 관리자용 슬롯 생성 -->
  <div id="adminControls" style="display:none; margin-top:20px;">
    <h2>관리자: 슬롯 생성</h2>
    시작일: <input type="date" id="start-date">
    종료일: <input type="date" id="end-date"><br>
    시작시간: <input type="time" id="start-time">
    종료시간: <input type="time" id="end-time"><br>
    <button id="btn-create-slots">슬롯 일괄 생성</button>
    <ul id="slot-list-admin"></ul>
  </div>

  <!-- 사용자용 슬롯 리스트 -->
  <div id="userSlots" style="display:none; margin-top:20px;">
    <h2>예약 가능한 슬롯</h2>
    <ul id="slot-list"></ul>
  </div>

  <!-- 주간 스케줄 테이블 -->
  <h2>이번 주 스케줄 (30분 단위, 월~일 8:00~23:30)</h2>
  <table class="schedule-table" id="weekly-schedule">
    <thead>
      <tr>
        <th>시간</th>
        <th>월</th><th>화</th><th>수</th>
        <th>목</th><th>금</th><th>토</th><th>일</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 예약 폼 (모달 대신 인라인) -->
  <div id="bookingForm">
    <h2>예약하기</h2>
    <form id="formBooking">
      <label>
        예약 타입:
        <label><input type="radio" name="type" value="합주" checked> 합주</label>
        <label><input type="radio" name="type" value="개인연습"> 개인연습</label>
      </label>
      <label>날짜: <input type="date" id="form-date" required></label>
      <label>시작 시간: <input type="time" id="form-start" required></label>
      <label>종료 시간: <input type="time" id="form-end" required></label>
      <div id="form-name-team">
        <label id="label-team">팀명: <input type="text" id="form-team"></label>
        <label id="label-name" style="display:none;">이름: <input type="text" id="form-name"></label>
      </div>
      <button type="submit">제출</button>
      <button type="button" id="btn-cancel">취소</button>
    </form>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // ─────────────── 헬퍼 함수 ───────────────
    function timeToMinutes(s) {
      const [h,m] = s.split(':').map(Number);
      return h*60 + m;
    }
    function minutesToTime(m) {
      return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
    }

    // ─────────────── Firebase 초기화 ───────────────
    const firebaseConfig = {
      apiKey: "AIzaSyCGroYj_1Mpw0GBUn0p37z4Nncl1chqLUc",
      authDomain: "motdy-2b3ea.firebaseapp.com",
      projectId: "motdy-2b3ea",
      storageBucket: "motdy-2b3ea.appspot.com",
      messagingSenderId: "376404804075",
      appId: "1:376404804075:web:d4d85f0baab14fe3a859ae"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ─────────────── UI 요소 바인딩 ───────────────
    const btnGoogle   = document.getElementById('btn-google-login');
    const btnLogout   = document.getElementById('btn-logout');
    const userInfo    = document.getElementById('user-info');
    const btnReserve  = document.getElementById('btn-reserve');
    const bookingForm = document.getElementById('bookingForm');
    const formBooking = document.getElementById('formBooking');
    const rbType      = document.getElementsByName('type');
    const labelTeam   = document.getElementById('label-team');
    const labelName   = document.getElementById('label-name');
    const inpDate     = document.getElementById('form-date');
    const inpStart    = document.getElementById('form-start');
    const inpEnd      = document.getElementById('form-end');
    const inpTeam     = document.getElementById('form-team');
    const inpName     = document.getElementById('form-name');
    const btnCancel   = document.getElementById('btn-cancel');

    // 관리자/사용자 영역
    const adminDiv      = document.getElementById('adminControls');
    const userDiv       = document.getElementById('userSlots');
    const slotList      = document.getElementById('slot-list');
    const slotListAdmin = document.getElementById('slot-list-admin');
    const btnCreate     = document.getElementById('btn-create-slots');

    // ─────────────── 로그인 핸들링 ───────────────
    btnGoogle.onclick = () => {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
        .catch(e => alert('구글 로그인 실패: '+e.message));
    };
    btnLogout.onclick = () => auth.signOut();

    auth.onAuthStateChanged(async user => {
      const token   = user ? await user.getIdTokenResult() : {};
      const isAdmin = token.claims.admin === true;

      btnGoogle.style.display = user ? 'none' : '';
      btnLogout.style.display = user ? '' : 'none';
      userInfo.textContent    = user ? `환영합니다, ${user.displayName}` : '';
      btnReserve.style.display = user ? '' : 'none';

      adminDiv.style.display = (user && isAdmin) ? '' : 'none';
      userDiv.style.display  = (!user || !isAdmin)  ? '' : 'none';

      if (user && isAdmin) loadAdminSlots();
      else loadUserSlots();
      renderWeeklySchedule();
    });

    // ─────────────── 관리자: 슬롯 생성 ───────────────
    btnCreate.onclick = async () => {
      const sd = document.getElementById('start-date').value;
      const ed = document.getElementById('end-date').value;
      const st = document.getElementById('start-time').value;
      const et = document.getElementById('end-time').value;
      let d = new Date(sd), last = new Date(ed);
      const batch = db.batch();
      while (d <= last) {
        const doc = db.collection('availability').doc();
        batch.set(doc, {
          date: d.toISOString().slice(0,10),
          start: st, end: et
        });
        d.setDate(d.getDate()+1);
      }
      await batch.commit();
      loadAdminSlots();
      renderWeeklySchedule();
    };
    async function loadAdminSlots() {
      slotListAdmin.innerHTML = '';
      const snap = await db.collection('availability')
        .orderBy('date').orderBy('start').get();
      snap.forEach(doc => {
        const {date,start,end} = doc.data();
        const li = document.createElement('li');
        li.textContent = `${date} ${start}~${end}`;
        slotListAdmin.appendChild(li);
      });
    }

    // ────────── “예약하기” 폼 토글 & 타입 변화 ──────────
    btnReserve.onclick = () => bookingForm.style.display = '';
    btnCancel.onclick  = () => bookingForm.style.display = 'none';

    rbType.forEach(r => r.onchange = () => {
      if (r.checked && r.value==='합주') {
        labelTeam.style.display = '';
        labelName.style.display = 'none';
      } else {
        labelTeam.style.display = 'none';
        labelName.style.display = '';
      }
    });

    // ─────────────── 사용자: 슬롯 리스트 ───────────────
    async function loadUserSlots() {
      slotList.innerHTML = '';
      const snap = await db.collection('availability')
        .orderBy('date').orderBy('start').get();
      for (let doc of snap.docs) {
        const { date, start, end } = doc.data();
        const bookingRef = db.collection('bookings').doc(doc.id);
        const bdoc       = await bookingRef.get();
        const li        = document.createElement('li');
        li.textContent  = `${date} ${start}~${end} : `;
        if (bdoc.exists) {
          const b   = bdoc.data();
          const who = b.type==='합주'?b.team:b.name;
          li.textContent += `예약완료 (${who})`;
        } else {
          const btn = document.createElement('button');
          btn.textContent = '예약하기';
          btn.onclick     = () => btnReserve.click();
          li.appendChild(btn);
        }
        slotList.appendChild(li);
      }
    }

    // ─────────────── 예약 제출 처리 ───────────────
    formBooking.onsubmit = async e => {
      e.preventDefault();
      const type     = [...rbType].find(r=>r.checked).value;
      const date     = inpDate.value;
      const startStr = inpStart.value;
      const endStr   = inpEnd.value;
      if (!date||!startStr||!endStr) return alert('모든 필드를 채워주세요.');

      // 개인연습은 당일만
      const today = new Date().toISOString().slice(0,10);
      if (type==='개인연습' && date!==today) {
        return alert('개인연습은 당일만 예약 가능합니다.');
      }
      // 시간 유효성 검사
      const sMin = timeToMinutes(startStr),
            eMin = timeToMinutes(endStr),
            dur  = eMin - sMin;
      if (dur<30||dur>60) {
        return alert('예약은 최소 30분, 최대 60분입니다.');
      }

      // 가용 슬롯 찾기
      const availSnap = await db.collection('availability')
        .where('date','==',date).get();
      let slotDoc = null;
      availSnap.forEach(d => {
        const a = d.data();
        if (sMin>=timeToMinutes(a.start) && eMin<=timeToMinutes(a.end)) {
          slotDoc = d; // 가장 마지막 충족 doc
        }
      });
      if (!slotDoc) return alert('해당 시간에 예약 가능한 슬롯이 없습니다.');

      // 충돌 검사
      const existing = await db.collection('bookings')
        .where('date','==',date).get();
      for (let bdoc of existing.docs) {
        if (bdoc.id===slotDoc.id) continue;
        const b = bdoc.data();
        const bs = timeToMinutes(b.start),
              be = timeToMinutes(b.end);
        if (sMin < be && eMin > bs) {
          return alert('해당 시간에 이미 예약이 있습니다.');
        }
      }

      // 이름/팀명
      const payload = { date, start: startStr, end: endStr, type };
      if (type==='합주') {
        if (!inpTeam.value) return alert('팀명을 입력하세요.');
        payload.team = inpTeam.value;
      } else {
        if (!inpName.value) return alert('이름을 입력하세요.');
        payload.name = inpName.value;
      }

      // 저장
      await db.collection('bookings').doc(slotDoc.id).set(payload);
      alert('예약 완료되었습니다!');
      bookingForm.style.display = 'none';
      loadUserSlots();
      renderWeeklySchedule();
    };

    // ─────────────── 주간 스케줄 렌더링 ───────────────
    async function renderWeeklySchedule() {
      const tbody = document.querySelector('#weekly-schedule tbody');
      tbody.innerHTML = '';
      const now = new Date(), day = now.getDay();
      const mon = new Date(now);
      mon.setDate(now.getDate() - (day===0?6:day-1));
      mon.setHours(0,0,0,0);

      const startStr = mon.toISOString().slice(0,10);
      const endDate  = new Date(mon.getTime()+6*86400000);
      const endStr   = endDate.toISOString().slice(0,10);
      const snap     = await db.collection('bookings')
        .where('date','>=',startStr).where('date','<=',endStr).get();

      const bookingMap = {};
      snap.forEach(d => {
        const b = d.data();
        const label = b.type==='합주'? b.team : b.name;
        const s = timeToMinutes(b.start),
              e = timeToMinutes(b.end);
        for (let t=s; t<e; t+=30) {
          bookingMap[`${b.date}_${minutesToTime(t)}`] = label;
        }
      });

      for (let h=8; h<=23; h++) {
        for (let m=0; m<60; m+=30) {
          const lbl = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
          const tr  = document.createElement('tr');
          tr.innerHTML = `<th>${lbl}</th>`;
          for (let i=0; i<7; i++) {
            const d = new Date(mon);
            d.setDate(mon.getDate()+i);
            const key = `${d.toISOString().slice(0,10)}_${lbl}`;
            tr.innerHTML += `<td>${bookingMap[key]||' '}</td>`;
          }
          tbody.appendChild(tr);
        }
      }
    }
  </script>
</body>
</html>
