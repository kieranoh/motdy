<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>합주 예약 시스템</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    /* 스케줄 테이블 스타일 */
    .schedule-table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    .schedule-table th,
    .schedule-table td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      min-width: 70px;
    }
    .schedule-table th { background: #f7f7f7; }
    /* 로그인 폼 스타일 */
    #loginSection input { margin-right: 5px; }
  </style>
</head>
<body>
  <h1>합주 예약 시스템</h1>

  <!-- 로그인 섹션 -->
  <div id="loginSection">
    <button id="btn-google-login">Google 로그인</button>
    <input type="email" id="email-input" placeholder="이메일">
    <input type="password" id="password-input" placeholder="비밀번호">
    <button id="btn-email-login">이메일 로그인</button>
  </div>
  <button id="btn-logout" style="display:none;">로그아웃</button>

  <!-- 관리자 UI -->
  <div id="adminControls" style="display:none; margin-top:20px;">
    <h2>관리자용 슬롯 생성</h2>
    시작일: <input type="date" id="start-date">
    종료일: <input type="date" id="end-date"><br>
    시작시간: <input type="time" id="start-time">
    종료시간: <input type="time" id="end-time"><br>
    <button id="btn-create-slots">슬롯 일괄 생성</button>
    <ul id="slot-list-admin"></ul>
  </div>

  <!-- 사용자 UI -->
  <div id="userSlots" style="display:none; margin-top:20px;">
    <h2>예약 가능한 슬롯</h2>
    <ul id="slot-list"></ul>
  </div>

  <!-- 주간 스케줄 테이블 -->
  <div id="scheduleSection" style="margin-top:30px;">
    <h2>이번 주 스케줄 (월요일~일요일, 8시~23시)</h2>
    <table class="schedule-table" id="weekly-schedule">
      <thead>
        <tr>
          <th>시간</th>
          <th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th><th>일</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase 초기화
   const firebaseConfig = {
  apiKey: "AIzaSyCGroYj_1Mpw0GBUn0p37z4Nncl1chqLUc",
  authDomain: "motdy-2b3ea.firebaseapp.com",
  projectId: "motdy-2b3ea",
  storageBucket: "motdy-2b3ea.firebasestorage.app",
  messagingSenderId: "376404804075",
  appId: "1:376404804075:web:d4d85f0baab14fe3a859ae",
  measurementId: "G-F2W9Y511E6"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // 초기 슬롯 시딩 (한 번만)
    async function seedInitialSlots() {
      const meta = db.collection('meta').doc('initialized');
      if (!(await meta.get()).exists) {
        const start = new Date();
        const end   = new Date(start.getTime() + 6*86400000);
        const st    = '18:00', et = '20:00';
        const batch= db.batch();
        for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
          batch.set(db.collection('availability').doc(), { date: d.toISOString().slice(0,10), start: st, end: et });
        }
        batch.set(meta, { done: true });
        await batch.commit();
      }
    }
    seedInitialSlots();

    // UI 레퍼런스
    const btnGoogle  = document.getElementById('btn-google-login');
    const btnEmail   = document.getElementById('btn-email-login');
    const btnLogout  = document.getElementById('btn-logout');
    const adminDiv   = document.getElementById('adminControls');
    const userDiv    = document.getElementById('userSlots');
    const schedDiv   = document.getElementById('scheduleSection');
    const listAdmin  = document.getElementById('slot-list-admin');
    const listUser   = document.getElementById('slot-list');
    const emailIn    = document.getElementById('email-input');
    const passIn     = document.getElementById('password-input');
    const btnCreate  = document.getElementById('btn-create-slots');

    // 로그인 핸들러
    btnGoogle.onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
      .catch(e => alert('Google 로그인 오류:' + e.message));
    btnEmail.onclick = () => auth.signInWithEmailAndPassword(emailIn.value, passIn.value)
      .catch(e => alert('이메일 로그인 오류:' + e.message));
    btnLogout.onclick = () => auth.signOut();

    // 상태 변화
    auth.onAuthStateChanged(async user => {
      const token = user ? await user.getIdTokenResult() : {};
      const isAdmin = token.claims.admin === true;
      document.getElementById('loginSection').style.display = user ? 'none' : '';
      btnLogout.style.display = user ? '' : 'none';
      adminDiv.style.display  = (user && isAdmin) ? '' : 'none';
      userDiv.style.display   = (!user || !isAdmin) ? '' : 'none';

      loadAdminSlots();
      loadUserSlots();
      renderWeeklySchedule();
    });

    // 관리자 슬롯 생성
    btnCreate.onclick = async () => {
      const sd = document.getElementById('start-date').value;
      const ed = document.getElementById('end-date').value;
      const st = document.getElementById('start-time').value;
      const et = document.getElementById('end-time').value;
      const batch = db.batch();
      let d = new Date(sd), last = new Date(ed);
      while (d <= last) {
        batch.set(db.collection('availability').doc(),
                  { date: d.toISOString().slice(0,10), start: st, end: et });
        d.setDate(d.getDate()+1);
      }
      await batch.commit();
      loadAdminSlots();
      renderWeeklySchedule();
    };

    // 관리자 슬롯 표시
    async function loadAdminSlots() {
      listAdmin.innerHTML = '';
      (await db.collection('availability')
        .orderBy('date').orderBy('start').get())
      .forEach(doc => {
        const { date, start, end } = doc.data();
        listAdmin.insertAdjacentHTML('beforeend', `<li>${date} ${start}~${end}</li>`);
      });
    }

    // 사용자 슬롯 및 예약 기능
    async function loadUserSlots() {
      listUser.innerHTML = '';
      for (let doc of (await db.collection('availability')
        .orderBy('date').orderBy('start').get()).docs) {
        const { date, start, end } = doc.data();
        const booking = (await db.collection('bookings').doc(doc.id).get());
        const text = booking.exists
          ? `예약됨 (${booking.data().team})`
          : `<button onclick="book('${doc.id}')">예약하기</button>`;
        listUser.insertAdjacentHTML('beforeend', `<li>${date} ${start}~${end} : ${text}</li>`);
      }
    }
    window.book = async id => {
      const team = prompt('팀명 입력');
      if (!team) return;
      try { await db.collection('bookings').doc(id).create({ team }); }
      catch { alert('이미 예약됨'); }
      loadUserSlots(); renderWeeklySchedule();
    };

    // 주간 스케줄 렌더링
    async function renderWeeklySchedule() {
      const tbody = document.querySelector('#weekly-schedule tbody');
      tbody.innerHTML = '';
      const now = new Date();
      // 해당 주 월요일 계산
      const day = now.getDay();
      const monday = new Date(now);
      monday.setDate(now.getDate() - (day === 0 ? 6 : day - 1));
      monday.setHours(0,0,0,0);

      // 예약맵 생성
      const map = {};
      const avail = await db.collection('availability')
        .where('date', '>=', monday.toISOString().slice(0,10))
        .where('date', '<=', new Date(monday.getTime()+6*86400000)
          .toISOString().slice(0,10))
        .get();
      for (let doc of avail.docs) {
        const { date, start } = doc.data();
        const b = await db.collection('bookings').doc(doc.id).get();
        if (b.exists) map[`${date}_${start}`] = b.data().team;
      }

      // 시간별 row
      for (let hour = 8; hour <= 23; hour++) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<th>${hour}:00</th>`;
        for (let i = 0; i < 7; i++) {
          const d = new Date(monday);
          d.setDate(monday.getDate() + i);
          const key = `${d.toISOString().slice(0,10)}_${hour.toString().padStart(2,'0')}:00`;
          tr.innerHTML += `<td>${map[key] ? map[key] : '&nbsp;'}</td>`;
        }
        tbody.appendChild(tr);
      }
    }
  </script>
</body>
</html>