<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>합주 예약</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>합주 예약 시스템</h1>

  <!-- 로그인/로그아웃 버튼 -->
  <button id="btn-login">로그인</button>
  <button id="btn-logout" style="display:none;">로그아웃</button>

  <!-- 관리자 전용 슬롯 생성/관리 UI -->
  <div id="adminControls" style="display:none; margin-top:20px;">
    <h2>관리자용: 슬롯 생성</h2>
    시작일: <input type="date" id="start-date">
    종료일: <input type="date" id="end-date"><br>
    시작시간: <input type="time" id="start-time">
    종료시간: <input type="time" id="end-time"><br>
    <button id="btn-create-slots">슬롯 일괄 생성</button>
    <ul id="slot-list-admin"></ul>
  </div>

  <!-- 사용자 전용 예약 리스트 -->
  <div id="userSlots" style="display:none; margin-top:20px;">
    <h2>예약 가능한 슬롯</h2>
    <ul id="slot-list"></ul>
  </div>

  <script>
    // 1) Firebase 초기화
    const firebaseConfig = {
  apiKey: "AIzaSyCGroYj_1Mpw0GBUn0p37z4Nncl1chqLUc",
  authDomain: "motdy-2b3ea.firebaseapp.com",
  projectId: "motdy-2b3ea",
  storageBucket: "motdy-2b3ea.firebasestorage.app",
  messagingSenderId: "376404804075",
  appId: "1:376404804075:web:d4d85f0baab14fe3a859ae",
  measurementId: "G-F2W9Y511E6"
};
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    // 2) 초기 슬롯 시딩 (한 번만)
    async function seedInitialSlots() {
      const metaRef = db.collection('meta').doc('initialized');
      const metaDoc = await metaRef.get();
      if (!metaDoc.exists) {
        const startDate = new Date('2025-06-01');
        const endDate   = new Date('2025-06-07');
        const startTime = '18:00', endTime = '20:00';
        const batch = db.batch();
        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate()+1)) {
          const dateStr = d.toISOString().slice(0,10);
          const slotRef = db.collection('availability').doc();
          batch.set(slotRef, { date: dateStr, start: startTime, end: endTime });
        }
        batch.set(metaRef, { done: true });
        await batch.commit();
      }
    }
    seedInitialSlots();

    // 3) UI 요소 가져오기
    const btnLogin  = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const adminDiv  = document.getElementById('adminControls');
    const userDiv   = document.getElementById('userSlots');
    const slotList  = document.getElementById('slot-list');
    const slotListAdmin = document.getElementById('slot-list-admin');
    const btnCreate = document.getElementById('btn-create-slots');

    // 4) 구글 로그인 구현
    btnLogin.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .catch(err => alert('로그인 실패: ' + err.message));
    };
    btnLogout.onclick = () => auth.signOut();

    // 5) 인증 상태 변화에 따른 UI 분기
    auth.onAuthStateChanged(async user => {
      const token = user ? await user.getIdTokenResult() : null;
      const isAdmin = token?.claims?.admin === true;

      btnLogin.style.display  = user ? 'none' : '';
      btnLogout.style.display = user ? '' : 'none';
      adminDiv.style.display  = (user && isAdmin) ? '' : 'none';
      userDiv.style.display   = (!user || !isAdmin) ? '' : 'none';

      if (!user || !isAdmin) {
        loadUserSlots();
      } else {
        loadAdminSlots();
      }
    });

    // 6) 관리자: 슬롯 일괄 생성 (폼 버튼)
    btnCreate.onclick = async () => {
      const sd = document.getElementById('start-date').value;
      const ed = document.getElementById('end-date').value;
      const st = document.getElementById('start-time').value;
      const et = document.getElementById('end-time').value;
      let d = new Date(sd), end = new Date(ed);
      const batch = db.batch();
      while (d <= end) {
        const dateStr = d.toISOString().slice(0,10);
        const ref = db.collection('availability').doc();
        batch.set(ref, { date: dateStr, start: st, end: et });
        d.setDate(d.getDate()+1);
      }
      await batch.commit();
      loadAdminSlots();
    };

    async function loadAdminSlots() {
      slotListAdmin.innerHTML = '';
      const snap = await db.collection('availability')
        .orderBy('date').orderBy('start').get();
      snap.forEach(doc => {
        const { date, start, end } = doc.data();
        const li = document.createElement('li');
        li.textContent = `${date} ${start}~${end}`;
        slotListAdmin.append(li);
      });
    }

    // 7) 사용자: 예약 가능한 슬롯 불러오기 & 예약 기능
    async function loadUserSlots() {
      slotList.innerHTML = '';
      const snap = await db.collection('availability')
        .orderBy('date').orderBy('start').get();
      for (let doc of snap.docs) {
        const { date, start, end } = doc.data();
        const id = doc.id;
        const bookingRef = db.collection('bookings').doc(id);
        const bdoc = await bookingRef.get();
        const li = document.createElement('li');
        li.textContent = `${date} ${start}~${end} : `;
        if (bdoc.exists) {
          li.textContent += `예약완료 (${bdoc.data().team})`;
        } else {
          const btn = document.createElement('button');
          btn.textContent = '예약하기';
          btn.onclick = async () => {
            const team = prompt('팀명을 입력하세요');
            if (!team) return;
            try {
              await bookingRef.create({ team });
              loadUserSlots();
            } catch {
              alert('이미 예약된 슬롯입니다.');
              loadUserSlots();
            }
          };
          li.append(btn);
        }
        slotList.append(li);
      }
    }
  </script>
</body>
</html>
